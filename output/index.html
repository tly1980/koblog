<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta charset="utf-8"><meta name="description" content="This is a demo site for Nikola."><meta name="author" content="Your Name"><title>Demo Site | Demo Site</title><link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="assets/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"><link href="assets/css/rst.css" rel="stylesheet" type="text/css"><link href="assets/css/code.css" rel="stylesheet" type="text/css"><link href="assets/css/colorbox.css" rel="stylesheet" type="text/css"><link href="assets/css/theme.css" rel="stylesheet" type="text/css"><link href="assets/css/custom.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml"></head><body>
<!-- Menubar -->
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">

        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>

            <a class="brand" href=".">
            Demo Site
            </a>
            <!-- Everything you want hidden at 940px or less, place within here -->
            <div class="nav-collapse collapse">
                <ul class="nav"><li><a href="archive.html">Archives</a>
            </li><li><a href="categories/index.html">Tags</a>
            </li><li><a href="rss.xml">RSS</a>

                </li></ul><ul class="nav pull-right"></ul></div>
        </div>
    </div>
</div>
<!-- End of Menubar -->
<div class="container-fluid" id="container-fluid">
    <!--Body content-->
    <div class="row-fluid">
    <div class="span2"></div>
    <div class="span8">
    
        <div class="postbox">
        <h1><a href="posts/ce-shi.html">测试</a>
        <small>  
             Posted: <time class="published" datetime="2013-08-16T13:47:02">2013-08-16 13:47</time></small></h1>
        <hr><p>Write your post here.</p>
            
    <p>
        <a href="posts/ce-shi.html#disqus_thread" data-disqus-identifier="cache/posts/ce-shi.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/2012-12-30-you-jian-wang-jia-wei-dong-xie-xi-du.html">"又见王家卫，东邪西毒（终极版）"</a>
        <small>  
             Posted: <time class="published" datetime="2012-12-30T08:24:00">2012-12-30 08:24</time></small></h1>
        <hr><p>一般电影的导演剪辑版本，都会变长，东邪西毒导演剪辑版，反而变短了。梁文道在锵锵说的这句话吊起了我的胃口。</p>
<p>看惯一般港片或好莱坞大片，看王家卫会不习惯。看一般电影，我们更习惯成为故事的聆听者。所听到故事总是具体的，我们之所以被吸引，通常是因为这个故事很有悬念，导演铺陈得很好，将这个故事叙述得峰回路转，荡气回肠。</p>
<p>但看王家卫电影，更像是看一个有主题的摄影展。看摄影展，会比较需要观众自发/自主地去产生连结。画面，音乐，是要营造一种氛围。情节，主角的对白，稍稍构成了接引思维或者情绪的导轨。王乐意玩捉迷藏，平铺直叙这种事情永远不会发生的。如果你足够聪明，而又有耐性的话，或许能看懂他的作品。这大概就是有些人很喜欢，以及很不喜欢他的原因。</p>
<p>这个导演剪辑版，是经过修复的，画面比以前 vcd / dvd 版本好太多。情节通过对白跟旁白推动，叙事性镜头少之又少，但正因为如此，几乎每个镜头都可单独拿出来做一个摄影作品，里头的“麻豆”是黄金时期的张国荣，林青霞，黄家辉。杜可风一定被王家卫赋予了无限自由度，恣意发挥，才有了里头太多精妙绝伦的镜头。光凭这点，都已有值回票价的感觉。</p>
<p>剧情大家耳熟能详了吧，基本上就是一群被情爱所伤，无比纠结的人，在茫茫荒漠中求解脱的药。</p>
<p>我主要想探讨的就是洪七跟欧阳锋。</p>
<p>欧阳锋是穿鞋的，洪七就是一个光脚的。一个穿鞋的，有身份，有阅历，世故的人，并非不会受到伤害（事实上欧阳锋的自我放逐，就是为大嫂耿耿于怀）；一个光脚的，无名小辈，没阅历，愣头青，一定会受到伤害。</p>
<p>洪七不是一个傻子。一个数钱数得很仔细的人，又如何会做不符合经济学原则的事情：为了一个“鸡蛋”去杀太尉府的人。他要帮鸡蛋妹决不是因为鸡蛋。</p>
<p>洪七说，他之所以会断一根手指是因为他的刀不如以前快了。他的刀不够快，是犹豫值不值（他知道鸡蛋妹是姜太公钓鱼，明白会一无所获）。他犹豫，是因为欧阳锋的价值观入侵了。放在以前，他不会想值不值的。欧阳锋对于鸡蛋妹，是断然不会帮的。</p>
<p>洪七付出代价，因为一个“鸡蛋”，断了手指；不过代价也成就了他，若干年后，人们谈论起洪七不会因为那“鸡蛋”，而是他单枪匹马，断了一根手指，灭了一帮太尉府的人。</p>
<p>即使断一根手指，洪七病重时，鸡蛋妹还是走了；洪七认了，也发现真正不离不弃的是糟糠之妻，不上台面，却可带去闯荡江湖；欧阳锋，最终饮了半坛“醉生梦死”，才发觉那是大嫂开的玩笑；黄药师的失忆，也不是因为坛酒，而是大嫂溘然而逝。</p>
<p>糙人洪七的药是，认了，放了，我觉得痛快就好了。套用流行的话，这是 EQ 高的表现，他很快 Bounce Back 了。</p>
<p>对于其他拥有精致灵魂的主角，他们药是什么？ 片中没有给出，反而是英文片名有点启发：</p>
<p>Ashes of Time。过去种种，已是时间灰烬；今日或明日种种，正成为时间灰烬；剧中人的悲剧之处，是因为没有活在当下而缅怀过去种种。这是一个无可争议的事实，而大概也是人们最容易忽视，最不愿接受的事实。</p>
<p>认清人世无常，大约是最好的药了。</p>
            
    <p>
        <a href="posts/2012-12-30-you-jian-wang-jia-wei-dong-xie-xi-du.html#disqus_thread" data-disqus-identifier="cache/posts/2012-12-30-you-jian-wang-jia-wei-dong-xie-xi-du.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/2012-12-12-emailyu-yu-ming-de-pei-zhi.html">"Email 与域名的配置 (SPF / DKIM)"</a>
        <small>  
             Posted: <time class="published" datetime="2012-12-12T21:30:00">2012-12-12 21:30</time></small></h1>
        <hr><p>长久以来都积压了不少 email 跟域名的疑问。纸上得来终觉浅，最近终于有时间集中将这些东西捋一下，具体实战一下。理清一些思路，有了更好的理解。</p>
<h4>第一点域名上的 MX 配置主要是用来收信的。</h4>
<p>譬如某个仁兄(foo@example.com) 要往 abc@keyonly.com 发信，这个仁兄的 MTU（就是 Postfix 或者 Sendmail ）首先向 keyonly.com 的 域名服务器查询 keyonly.com 的 MX 记录。  <br>
譬如查到 MX 记录指向 mail.keyonly.com ，example.com MTU 就会向 mail.keyonly.com 的 MTA 发送 SMTP 请求 （现在流行 ESMTP ）进行投递。</p>
<p>发 email 第一步解决了，知道信要往哪一个邮局发去，即往收件人的域名地址的 MX 记录上指向的机器发去。  <br>
问题又来了，如何确认发信人的身份呢？</p>
<h4>通过 SPF 跟 DKIM 确认发信人的身份</h4>
<p>SMTP 协议允许任何计算机以任何源地址发邮件。因此有很多专门做垃圾邮件的人以伪装邮件的方式来发信。要解决这个问题，还是通过域名。</p>
<blockquote>
<ol><li>SPF 是用于验证发件人地址是否被某个域认可，即 <strong>mailed-by</strong>；    </li>
<li>DomainKey/DKIM 用来验证邮件内容是否被某个域认可，即 <strong>signed-by</strong>。</li>
</ol></blockquote>
<h4>1.) SPF</h4>
<p>SPF 实质是通过域名服务器向外中提供一个 Outbound MTA 白名单列表。</p>
<p>举一具体例子。</p>
<p>这些信息可以通过 dig 命令获取。</p>
<div class="code"><pre><span class="n">dig</span> <span class="n">TXT</span> <span class="n">keyonly</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<div class="code"><pre><span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="o">:</span>
<span class="n">keyonly</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>        <span class="mi">86360</span>   <span class="n">IN</span>  <span class="n">TXT</span> <span class="s">"v=spf1 include:_spf.google.com ~all"</span>
</pre></div>


<p>这是 keyonly.com 的配置，相对简单，仅仅允许 _spf.google.com，其他都会 softfail 掉 (~all)。 
如果配置为：</p>
<div class="code"><pre><span class="p">;;</span> <span class="n">ANSWER</span> <span class="n">SECTION</span><span class="o">:</span>
<span class="n">keyonly</span><span class="p">.</span><span class="n">com</span><span class="p">.</span>        <span class="mi">86360</span>   <span class="n">IN</span>  <span class="n">TXT</span> <span class="s">"v=spf1 a mx include:_spf.google.com include:sendgrid.net ~all"</span>
</pre></div>


<p>就是还允许 keyonly.com 的所有 a 记录跟 mx 记录，_spf.google.com 和 sendgrid.net 。</p>
<p>spf 配置，可以很灵活，很强大，详细请看这里：
http://www.openspf.org/SPF_Record_Syntax</p>
<h4>2.) DKIM</h4>
<p>DKIM 跟 DomainKey 有点大同小异，都是在 MTA （注意，这个是 Outbound MTA）发信时，对邮件进行签名。私钥由 Outbound MTA 保管着，不对外公开，公钥就放在域名的 TXT 项目上。接收方要验证信息的签名，可根据邮件上提供的信息，构造出含有公钥信息的域名地址，去该地址获取公钥。</p>
<p>对据说 DomainKey 是 Yahoo 发明的，是 DKIM 前身。貌似 DKIM 更强大，更流行。具体那个地方强大，请自己狗一下。而 Google app 也支持 DKIM。</p>
<p>注意，是签名，而不是加密。签名就是暗示着对邮件体的 Digest 通过私钥进行加密。Inbound MTA 在接收时候，就会从发件人域名服务器上查到公钥信息，然后对签名信息进行解密。如果解密得出的 Digest 值跟计算出来的一致，那证明邮件的合法性。</p>
<p>譬如我有某个从 keyonly.com 发出来的 email，其 DKIM 签名如下：</p>
<div class="code"><pre><span class="n">DKIM</span><span class="o">-</span><span class="n">Signature</span><span class="o">:</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">a</span><span class="o">=</span><span class="n">rsa</span><span class="o">-</span><span class="n">sha256</span><span class="p">;</span> <span class="n">c</span><span class="o">=</span><span class="n">relaxed</span><span class="o">/</span><span class="n">relaxed</span><span class="p">;</span>
        <span class="n">d</span><span class="o">=</span><span class="n">keyonly</span><span class="p">.</span><span class="n">com</span><span class="p">;</span> <span class="n">s</span><span class="o">=</span><span class="n">google</span><span class="p">;</span>
        <span class="n">h</span><span class="o">=</span><span class="n">mime</span><span class="o">-</span><span class="n">version</span><span class="o">:</span><span class="n">x</span><span class="o">-</span><span class="n">originating</span><span class="o">-</span><span class="n">ip</span><span class="o">:</span><span class="n">date</span><span class="o">:</span><span class="n">message</span><span class="o">-</span><span class="n">id</span><span class="o">:</span><span class="n">subject</span><span class="o">:</span><span class="n">from</span><span class="o">:</span><span class="n">to</span>
         <span class="o">:</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="p">;</span>
        <span class="n">bh</span><span class="o">=</span><span class="n">EVanec6ZKH</span><span class="o">/</span><span class="n">vkbb95pMLG07OuPp</span><span class="o">+</span><span class="n">QtQ3z71oXKCTejw</span><span class="o">=</span><span class="p">;</span>
        <span class="n">b</span><span class="o">=</span><span class="n">E02Fj</span><span class="o">/</span><span class="n">ROj18sLVc395zPdCTRu1L8Gsie63QG</span><span class="o">+</span><span class="n">tF4PoeS7z3Yzvn7m2zWArjQfaVN51</span>
         <span class="n">hSLE7jXRm1S5y4uaZboO2jRy9stCeikZ5xs</span><span class="o">/</span><span class="mi">38</span><span class="n">MrDZGh8IlkrUHySouHeqmdh5epwugT</span>
         <span class="n">riTKjLMUF9t4YNO75i14mptgphw</span><span class="o">/</span><span class="mi">7</span><span class="n">VNP2tjTY</span><span class="o">=</span>
</pre></div>


<p>d=keyonly.com; s=google
重新构造出 DKIM 信息的域名：</p>
<div class="code"><pre><span class="cp">${</span><span class="n">s</span><span class="cp">}</span>._domainkey.<span class="cp">${</span><span class="n">d</span><span class="cp">}</span>
</pre></div>


<p>即：</p>
<div class="code"><pre><span class="n">google</span><span class="p">.</span><span class="n">_domainkey</span><span class="p">.</span><span class="n">keyonly</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<p>所以我们可以通过 dig 获取 这个 DKIM 的公钥：</p>
<div class="code"><pre><span class="n">dig</span> <span class="n">TXT</span> <span class="n">google</span><span class="p">.</span><span class="n">_domainkey</span><span class="p">.</span><span class="n">keyonly</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<div class="code"><pre><span class="n">google</span><span class="p">.</span><span class="n">_domainkey</span><span class="p">.</span><span class="n">keyonly</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="mi">86400</span> <span class="n">IN</span> <span class="n">TXT</span> <span class="s">"v=DKIM1\; k=rsa\; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCF33Yl1sVLxLcS5UYUDdctOv2pdbaiYm1FRdSFzjvtO1b05zeXMJWKzXpGqpqh3i9sNNosrfmGKjjp/v+mklihVJUv7gRy/SyHg1WI8zRZNGfBtS0rE4s+jGeqtI2B2s4anJ0fcsps7N0kYjArBPCrv7LspPnCnHn6bggJZXjsGwIDAQAB"</span>
</pre></div>


<p>一个域名上允许多个 DKIM 公钥。因为 DKIM 签名上的 s 项只要不重复就好了，所以我们完全可以有</p>
<ul><li>google._domain.keyonly.com  =&gt; google app 的 dkim</li>
<li>sendgrid._domain.keyonly.com =&gt; sendgrid 的 dkim</li>
<li>postfix._domain.keyonly.com  =&gt; 我的 postfix 的 dkim</li>
</ul><h4>3）SPF 跟 DKIM 的结合使用</h4>
<p>SPF 跟 DKIM 完全可以绑定到不同域名上。譬如说，从 keyonly.com 发出来的 email 不用必须是用 keyonly.com 签名的，完全可以是其他域名签名的。</p>
<p>譬如说，我收到 NAB 银行的 email 签名的就是 Ubank (Ubank 是 NAB 的一个子银行)。感觉是他们    共用某些 IT 构架所导致的。</p>
<h3>后记</h3>
<ul><li>配置的时候牵涉到 DNS 设置，可以通过 dig 命令来获取 DNS 信息。  </li>
<li>而 gmail 允许的一些特性会另调试变得简单：<ul><li>signed by, mailed by （对着收件人按右键）。</li>
<li>show original 会显示邮件的原始信息。</li>
</ul></li>
</ul><p>一般大的 email 服务器会要求 SPF / DKIM 至少有一样；否则被 SPAM 几率就会增加。</p>
<p>实际上有很多大公司大机构，都不一定将这个问题处理得很好。譬如 NAB （National Australia Bank） 的 email 就连 SPF 都没有设置，虽然有设置 DKIM，但却用的是自己子银行 Ubank 的。严格来说，这不是一个金融公司专业的 IT 表现。实际上 NAB 前段还专门发信通知大家小心被钓鱼邮件骗。如果它能一早就做好 SPF / DKIM ，应该可以提高犯罪分子的作案难度，减少出现问题的机会。</p>
<p>而这点 CBA 就比 NAB 做得好多了，SPF / DKIM 都正确设置了，感觉比较专业。</p>
            
    <p>
        <a href="posts/2012-12-12-emailyu-yu-ming-de-pei-zhi.html#disqus_thread" data-disqus-identifier="cache/posts/2012-12-12-emailyu-yu-ming-de-pei-zhi.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/2012-12-01-django-admin-performance-optimization-1.html">"Django Admin 的性能优化一"</a>
        <small>  
             Posted: <time class="published" datetime="2012-12-01T15:35:00">2012-12-01 15:35</time></small></h1>
        <hr><blockquote>
<p>Django Admin 让程序猿不写太多代码就生产一功能基本齐备的后端，确实是很好很强大的。但很好很强大的工具也通常比较笨，会有多余操作，导致性能不大好。优化本来应针对业务，尽量不要去碰后台管理的优化，除非真的很闲。
然而，Admin 真的是慢得让开发人员也无法忍受，一个页面产生500条语句，耗时十几秒，所以忍不住要去改改。在某些项目，Admin 页面就是产品的正式后端管理工具，那部分是有企业客户用的。如果想顺利收到钱，不想被xxoo的话，也有优化 Admin 的需要。</p>
</blockquote>
<h3>问题：List 页面当使用到外键产生过多的查询</h3>
<p>select_related 可以设置为 True。 因为 Django ORM 默认是 Lazy Load 的，通常外键的属性不会在产生 List 结果的 QuerySet 里头被装载，而要等到你调用其属性了才会装载。
譬如有一个 Model 叫 Blog，有一个外键 Author。</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Charfield</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Charfield</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Charfield</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Charfield</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Author</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">author_name</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">'</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">author</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
</pre></div>


<p>然后你希望在 Admin list 里头见到 Author 通常这么做：</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">BlogAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">,</span> <span class="s">'author_name'</span><span class="p">)</span>
</pre></div>


<p>这个时候，如果调用 Admin 的 Blog 的 list page 通常产生 100 条以上查询语句。因为 author_name 方法会引用到外键`对象 author ，而 Admin list 分页默认是 100 条记录为一个分页。
100 条查询语句，现在的机器那么牛，实在不能算什么。而如果你有 n 个外键需要被显示，就会产 n * 100 条语句，而且他们都是串行执行的，因为是 Lazy 装载，而在 Template 里头是逐个被显示出来。。。</p>
<p>解决办法就是让 BlogAdmin 在产生 queryset 的时候对外键 Author 产生 JOIN 。
注意，上面的代码里，Blog.author 这个field 因为没设置 null=True，因此会产生 INNER JOIN，反之产生 LEFT OUTER JOIN，因为 author 可为空。</p>
<h3>解决：办法有二</h3>
<p>1). 修改 BlogAdmin 的 select_related 开关。</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">BlogAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">select_related</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">,</span> <span class="s">'author_name'</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>


<p>这个办法的好处就是简单，缺点是不够灵活。因为这个会把 Blog 所有的外键都 JOIN 进来，不管他们是否在 list_display 里头设置了。</p>
<p>2). 重载 Admin 的 queryset 方法。</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">BlogAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">,</span> <span class="s">'author_name'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BlogAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'author'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span>

    <span class="o">...</span>
</pre></div>


<p>在此你可以显式指定那些外键需要被重载。不仅如此，select_related 还允许继续将外键的外键级联叠加进来。
譬如：</p>
<div class="code"><pre><span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'author'</span><span class="p">,</span> <span class="s">'author__nationality'</span><span class="p">)</span>
</pre></div>


<p>上面的例子是不仅连 author 会 join，连 nationality 也会被 join 。
虽然没有做过实验，但是猜测应该是可以无限级联下去。
因为 author 已经是外键了，所以 select_related 中可以将 author 参数去掉，简写成如下：</p>
<div class="code"><pre><span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'author__nationality'</span><span class="p">)</span>
</pre></div>
            
    <p>
        <a href="posts/2012-12-01-django-admin-performance-optimization-1.html#disqus_thread" data-disqus-identifier="cache/posts/2012-12-01-django-admin-performance-optimization-1.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/2012-12-01-django-admin-performance-optimization-2.html">"Django Admin 的性能优化二"</a>
        <small>  
             Posted: <time class="published" datetime="2012-12-01T15:35:00">2012-12-01 15:35</time></small></h1>
        <hr><blockquote>
<p>Django Admin 让程序猿不写太多代码就生产一功能基本齐备的后端，确实是很好很强大的。但很好很强大的工具也通常比较笨，会有多余操作，导致性能不大好。优化本来应针对业务，尽量不要去碰后台管理的优化，除非真的很闲。
然而，Admin 真的是慢得让开发人员也无法忍受，一个页面产生500条语句，耗时十几秒，所以忍不住要去改改。在某些项目，Admin 页面就是产品的正式后端管理工具，那部分是有企业客户用的。如果想顺利收到钱，不想被xxoo的话，也有优化 Admin 的需要。</p>
</blockquote>
<h3>问题：List 页面当外键需要做聚合查询统计的时候</h3>
<p>请想象你要做一个电子商务的拍卖，有如下这两个类：
一个 Product 可以有多个 Bid。典型的 1-n 关系，Product 是 Bid 的外键。</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">bid_count</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">bid_accepted</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">accepted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">Bid</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">accepted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Product</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>


<p>很简单很直观吧。好了，然后你有这样一个 admin，问题就来了 。。。</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">ProductAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">display_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'bid_count'</span><span class="p">,</span> <span class="s">'bid_accepted'</span><span class="p">,</span> <span class="o">...</span> <span class="p">)</span>
</pre></div>


<p>通过 select_related 搞定了其他的外键，但就是 bid_count 搞不定啊，而 bid_count 跟 bid_accepted 每个就引起一次 sql 查询，一个 Admin 的 list 页面 200 条 SQL 呢。  <br>
山穷水复疑无路，柳暗花明又一村。  <br>
重载 Admin 的 queryset 方法，搞定了 bid_count:</p>
<div class="code"><pre><span class="k">class</span> <span class="nc">ProductAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">display_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'bid_count'</span><span class="p">,</span> <span class="s">'bid_accepted'</span><span class="p">,</span> <span class="o">...</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BlogAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">queryset</span><span class="p">()</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span> <span class="o">...</span><span class="p">)</span> <span class="c"># 这里去搞定其他外键</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">bid_count</span> <span class="o">=</span> <span class="n">Count</span><span class="p">(</span><span class="n">bids</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">qs</span>
</pre></div>


<p>好的这个 annotate 下去，搞定了 100 条 SQL，结果还剩下 100 条呢，bid_accepted 可以搞定么？？  <br>
所以很自然就想到如下的语句</p>
<div class="code"><pre><span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">bid_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="n">bids</span><span class="p">,</span> <span class="n">bids__accepted</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>


<p>生成的 sql 如下：</p>
<div class="code"><pre> <span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span>
     <span class="k">COUNT</span><span class="p">(</span><span class="o">`</span><span class="n">bid</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">bid_count</span><span class="o">`</span><span class="p">,</span> 
     <span class="k">COUNT</span><span class="p">(</span><span class="o">`</span><span class="n">bid</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">bid_accepted</span><span class="o">`</span> <span class="k">FROM</span> 
         <span class="o">`</span><span class="n">product</span><span class="o">`</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="o">`</span><span class="n">bid</span><span class="o">`</span> <span class="k">ON</span> <span class="p">(</span><span class="o">`</span><span class="n">product</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="o">=</span> <span class="o">`</span><span class="n">bid</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">product_id</span><span class="o">`</span><span class="p">)</span> 
         <span class="k">GROUP</span> <span class="k">BY</span> 
            <span class="n">product</span><span class="p">.</span><span class="o">*</span> <span class="c1">-- 懒得写了，反正就是 product 的每一项。</span>
</pre></div>


<p>显然，这并非我们想要的，bid_accepted 也丢失了。</p>
<p>经过一番摸索，我发现了 queryset 还有一个很好很强大的 extra 功能，允许我们嵌入子查询所以将代码改成如下：</p>
<div class="code"><pre><span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">extra</span><span class="p">({</span>
    <span class="s">'bid_count'</span><span class="p">:</span> <span class="s">'SELECT COUNT(*) FROM bid </span><span class="se">\</span>
<span class="s">        WHERE product.id = bid.product_id and bid.accepted=1'</span><span class="p">,</span>

    <span class="s">'bid_accepted'</span><span class="p">:</span> <span class="s">'SELECT COUNT(*) FROM bid</span><span class="se">\</span>
<span class="s">        WHERE product.id = bid.submission_id and haggler_bid.accepted=1'</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>


<p>生成 SQL 如下</p>
<div class="code"><pre><span class="k">SELECT</span> 
    <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">bid</span> <span class="k">WHERE</span> <span class="n">product</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">product_id</span><span class="p">)</span> <span class="k">AS</span> <span class="o">`</span><span class="n">bid_count</span><span class="o">`</span><span class="p">,</span> 
    <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">bid</span> <span class="k">WHERE</span> <span class="n">product</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">product_id</span> <span class="k">and</span> <span class="n">bid</span><span class="p">.</span><span class="n">accepted</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
        <span class="k">AS</span> <span class="o">`</span><span class="n">bid_accepted</span><span class="o">`</span><span class="p">,</span> 
    <span class="n">product</span><span class="p">.</span><span class="o">*</span>
         <span class="k">FROM</span> <span class="n">product</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">product</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">100</span>
</pre></div>


<p>正是鄙人想要的~ :)。</p>
<p>从 Django Debug Tool 上看到的查询语句数马上降低为 3 条，查询时间也降低到 35ms 内，耗时仅为优化前的 1/10 多一些。<br>
即使这条查询语句含有子查询，但也总比100多200条查询好多了！</p>
<p>其实这个 extra 完全可以自定制 product 的 model manager 里头，不过项目刚上手，还不是很熟悉，还是先不冒险了。</p>
            
    <p>
        <a href="posts/2012-12-01-django-admin-performance-optimization-2.html#disqus_thread" data-disqus-identifier="cache/posts/2012-12-01-django-admin-performance-optimization-2.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/2012-11-27-auto-deployment-with-fabric.html">"用 Fabric 跟 Cuisine 做自动化发布"</a>
        <small>  
             Posted: <time class="published" datetime="2012-11-27T11:33:00">2012-11-27 11:33</time></small></h1>
        <hr><p>在招工广告上经常见到提到 DevOps。<br>
我是土人，不晓得是神马玩意儿，狗了一番，度了一把，貌似有点懂了：大概就是自动化部署的意思。<br>
Ops 就是 Operation, Dev 如无意外就是开发。<br>
两个单词加在一起，依据鄙人理解，大概就是把 Operation 这个动作以代码的方式反映出来。  </p>
<p>最简单的部署，就是一行行敲命令行敲上去。<br>
本人这类菜鸟，都是东抄一行，西抄一行命令那么搞出来的。<br>
人工介入太多的结果是，发布出来的东西可能会不稳定，因为不排除中间漏了东西。而且发布过程可能会有许多错误。<br>
解决办法就是让电脑替我们做事，最初步的方法就是使用部署脚本。比较高级一些，或者说比较专业的做法就是使用 Chef 或者 Puppet 这类的工具去做部署。  </p>
<p>之前也好奇试了一下 Chef，有感于一个 Chef recipie 实在需要太多文件了。搞不懂用shell都是几行的东西，他能搞 n 个文件夹，n 个文件出来。然后这玩意儿还很火。囧rz...<br>
鉴于本人智商有限，刚刚接触 DevOps 这种东西，还是玩一些 low tech 的东西吧。<br>
DevOps 中，Python 界的<a href="http://fabfile.org">Fabric</a> 也经常被提起。而据说 Instagram 就是用 <a href="http://fabfile.org">Fabric</a> 去做的。而有人在这 <a href="http://fabfile.org">Fabric</a> 之上做了 <a href="https://github.com/sebastien/cuisine">Cuisine</a>，多做一层封装，提供多一些的抽象，简化了某些 API。</p>
<p>废话少说，奉上代码：  </p>
<h4>一、配置系统基本环境的代码</h4>
<p>主要入口是 prepare_system，其中必须的参数是你必须提供 admin_user 用户名。<br>
这段代码会创建一个新的用户，而其属于 admin 组。这个用户会使用你账号下的 DSA public key，以供后来免密码登陆。</p>
<p>这样你以后就可以把 root 的 ssh 登陆给禁止掉，可以防止别人暴力破解 root 密码。
上面也有配置 iptables 的防火墙代码，从网上抄来的，很小白，请大家不要攻击。。。</p>
<p>其中也有不少都可以删掉的东西，譬如 prepare_rbenvs, prepare_devenv 。用不到尽管删除掉。</p>
<div class="code"><pre><span class="n">fab</span> <span class="o">-</span><span class="n">H</span> <span class="n">yourhost</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="n">prepare_system</span><span class="o">:</span><span class="n">new_admin</span>
</pre></div>


<p>{% gist 4151899 %}</p>
<h4>二、自动生成 Octopress 的博客代码。</h4>
<p>使用方法很简单。先写好博客，commit&amp;push 后就用调用 fabric 进行部署。</p>
<div class="code"><pre><span class="n">fab</span> <span class="o">-</span><span class="n">H</span> <span class="n">keyonly</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">u</span> <span class="n">your_user</span> <span class="n">deploy</span>
</pre></div>


<div class="code"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">sudo</span><span class="p">,</span> <span class="n">cd</span>
<span class="kn">from</span> <span class="nn">fabric.context_managers</span> <span class="kn">import</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">cuisine</span> <span class="kn">import</span> <span class="n">dir_exists</span><span class="p">,</span> <span class="n">file_write</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">upstart_ensure</span><span class="p">,</span> <span class="n">run</span>


<span class="n">site_cfg</span> <span class="o">=</span> <span class="s">"""</span>
<span class="s">server {</span>
<span class="s">    server_name    www.keyonly.com    keyonly.com  keyonly.test;</span>
<span class="s">    access_log /var/log/nginx/keyonly.access.log;</span>
<span class="s">    index index.html index.htm;</span>

<span class="s">    location / {</span>
<span class="s">        root /srv/keyonly.com/;</span>
<span class="s">        try_files $uri $uri/ /index.html;</span>
<span class="s">    }</span>
<span class="s">}</span>
<span class="s">"""</span>


<span class="k">def</span> <span class="nf">test_exists</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'~'</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_exists</span><span class="p">(</span><span class="s">'blogging'</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">'not exist'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">'exist'</span>


<span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'~'</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_exists</span><span class="p">(</span><span class="s">'blogging'</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">'mkdir blogging'</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'blogging'</span><span class="p">):</span>
                <span class="n">run</span><span class="p">(</span><span class="s">'git clone git://github.com/imathis/octopress.git'</span><span class="p">)</span>
                <span class="n">run</span><span class="p">(</span><span class="s">'git clone git://github.com/tly1980/my_blog.git'</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'~/blogging/octopress'</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">prefix</span><span class="p">(</span><span class="s">'source ~/.bash_profile'</span><span class="p">):</span>
            <span class="c"># install the desire ruby version</span>
            <span class="n">run</span><span class="p">(</span><span class="s">'bundle install'</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'~/blogging/my_blog'</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">'git pull'</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'~/blogging/octopress'</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">run</span><span class="p">(</span><span class="s">'rm Rakefile _config.yml config.rb source'</span><span class="p">)</span>

        <span class="n">run</span><span class="p">(</span><span class="s">'ln -s ../my_blog/Rakefile .'</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">'ln -s ../my_blog/_config.yml .'</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">'ln -s ../my_blog/config.rb .'</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">'ln -s ../my_blog/source .'</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">'rake generate'</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="s">'~'</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">sudo</span><span class="p">(</span><span class="s">'rm -rvf /srv/keyonly.com'</span><span class="p">)</span>

        <span class="n">sudo</span><span class="p">(</span><span class="s">'cp -r blogging/octopress/public /srv/keyonly.com'</span><span class="p">)</span>
        <span class="n">sudo</span><span class="p">(</span><span class="s">'chmod -R 0755 /srv/keyonly.com'</span><span class="p">)</span>

    <span class="n">file_write</span><span class="p">(</span><span class="s">'/etc/nginx/sites-available/keyonly.com'</span><span class="p">,</span> <span class="n">site_cfg</span><span class="p">,</span> <span class="n">sudo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">(</span><span class="s">'/etc/nginx/sites-enabled/keyonly.com'</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="s">'ln -s /etc/nginx/sites-available/keyonly.com /etc/nginx/sites-enabled/keyonly.com'</span><span class="p">)</span>

    <span class="n">upstart_ensure</span><span class="p">(</span><span class="s">'nginx'</span><span class="p">)</span>
</pre></div>
            
    <p>
        <a href="posts/2012-11-27-auto-deployment-with-fabric.html#disqus_thread" data-disqus-identifier="cache/posts/2012-11-27-auto-deployment-with-fabric.html">Comments</a>

        </p></div>
        <div class="postbox">
        <h1><a href="posts/2012-11-27-di-pian-bo-ke.html">"第一篇博客"</a>
        <small>  
             Posted: <time class="published" datetime="2012-11-27T04:23:00">2012-11-27 04:23</time></small></h1>
        <hr><p>闲置了大半年的 Linode 终于真正用起来了。<br>
最近一直在玩 Vagrant 跟 Fabric 的东西，终于能够做到自动化安装跟发布程序了。
现在可以用 Octopress 写博客了~！！ </p>
<p>代码高亮还是很不错的说</p>
<p>python</p>
<div class="code"><pre><span class="k">print</span> <span class="s">"hello, world~!"</span>
</pre></div>


<p>javascript</p>
<div class="code"><pre><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello, world~!'</span><span class="p">);</span>
</pre></div>


<p>coffeescript</p>
<div class="code"><pre><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"hello, world~!"</span>
</pre></div>
            
    <p>
        <a href="posts/2012-11-27-di-pian-bo-ke.html#disqus_thread" data-disqus-identifier="cache/posts/2012-11-27-di-[?]-pian-bo-ke.html">Comments</a>

        </p></div>
    
<div>
<ul class="pager"></ul></div>

    
       <script type="text/javascript">var disqus_shortname="nikolademo";(function(){var a=document.createElement("script");a.async=true;a.type="text/javascript";a.src="http://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(a)}());</script></div>
    </div>
    <!--End of body content-->
</div>
<div class="footerbox">
    Contents © 2013         <a href="mailto:joe@demo.site">Your Name</a> - Powered by         <a href="http://nikola.ralsina.com.ar">Nikola</a>         
</div>

    <!-- Social buttons -->
    <div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
    <a class="addthis_button_more">Share</a>
    <ul><li><a class="addthis_button_facebook"></a>
    </li><li><a class="addthis_button_google_plusone_share"></a>
    </li><li><a class="addthis_button_linkedin"></a>
    </li><li><a class="addthis_button_twitter"></a>
    </li></ul></div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script><!-- End of social buttons --><script src="assets/js/jquery-1.7.2.min.js" type="text/javascript"></script><script src="assets/js/bootstrap.min.js" type="text/javascript"></script><script src="assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script></body></html>